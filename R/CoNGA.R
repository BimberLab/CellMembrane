
utils::globalVariables(
  names = c('barcode', 'clusters_gex', 'clusters_tcr', 'nndists_gex', 'nndists_tcr', 'is_invariant', 'conga_scores', 'conga_fdr_values'),
  package = 'CellMembrane',
  add = TRUE
)



#' @title Run CoNGA
#'
#' @description Runs CoNGA on a seurat object
#' @param seuratObj The Seurat object containing the data to be run using CoNGA.
#' @param tcrFileFromRdiscvr The 10x clonotypes file for this Seurat Object created by Rdiscvr::CreateMergedTcrClonotypeFile().
#' @param seuratToCongaDir The directory to store the results of .SeuratToConga() (the input files for the python call to run_CoNGA()).
#' @param assayName Pass-through variable for accessing the assay name within the Seurat object for .SeuratToConga().
#' @param organism 'human' or 'rhesus'
#' @param runCongaOutputFilePrefix prefix for the output files from the python call to run_CoNGA().
#' @param gexDatatype This should be "10x_h5" since we're using DropletUtils to write the counts, although "h5ad" is supported.
#' @param runCongaOutfilePrefixForQcPlots Prefix for the qc output files to be generated by run_CoNGA().
#' @param runCongaOutputDirectory The directory that will store the many files created during run_CoNGA().
#' @param congaMetadataPrefix A prefix to be added to the columns of the metadata that will be added from CoNGA within the returned Seurat object.
#' @return A Seurat object with the conga metadata relevant to TCR + gene expression clustering appended. 
#' @examples
#' \dontrun{
#'   CreateMergedTcrClonotypeFile(seuratObj,
#'                                outputFile = "./tcrs.csv")
#'   congaSeuratObj <- RunCoNGA(seuratObj = seuratObj,
#'                              tcrFileFromRdiscvr = "./tcrs.csv",
#'                              organism = "rhesus")
#' }
#' @export

RunCoNGA <- function(seuratObj=NULL,
                     tcrFileFromRdiscvr = NULL, 
                     seuratToCongaDir = "./seuratToConga", 
                     assayName = "RNA", 
                     organism = NULL,
                     runCongaOutputFilePrefix = "conga_output", 
                     gexDatatype = "10x_h5", 
                     runCongaOutfilePrefixForQcPlots = "qc_plots", 
                     runCongaOutputDirectory = "./conga_output", 
                     congaMetadataPrefix = "conga_") {
  #check python requirements
  if (!reticulate::py_available(initialize = TRUE)) {
    stop(paste0('Python/reticulate not configured. Run "reticulate::py_config()" to initialize python'))
  }
  
  if (!reticulate::py_module_available('conga')) {
    stop('The conga python package has not been installed! If you believe it has been installed, run reticulate::import("conga") to get more information and debug')
  }
  
  #check required inputs
  if (is.null(seuratObj)){
    stop("seuratObj is NULL. Please supply a Seurat object to run CoNGA.")
  }
  
  if (is.null(tcrFileFromRdiscvr)){
    stop("tcrFileFromRdiscvr is NULL. Please supply a csv file created with Rdiscvr::CreateMergedTcrClonotypeFile().")
  } else if(!file.exists(tcrFileFromRdiscvr)){
    stop("tcrFileFromRdsicvr does not exist. Please ensure your path specification is correct and that there wasn't an issue with running Rdiscvr::CreateMergedTcrClonotypeFile().")
  }
  
  if (is.null(organism)){
    stop("Please specify an organism. 'human', 'mouse', and 'rhesus' are supported.")
  } else if (!(organism %in% c('human', 'mouse','rhesus') )){
    stop("Unsupported organism type supplied. Please specify one of 'human', 'mouse', or 'rhesus'.")
  }
  
  #strip trailing slashes from runCongaOutputDirectory directory if user-supplied
  if (grepl("/$", runCongaOutputDirectory)){
    runCongaOutputDirectory <- gsub("/$", "", runCongaOutputDirectory)
  }
  #make the runCongaOutputDirectory directory if it doesn't already exist (this is where the output files from run_CoNGA() will be written.)
  if (!dir.exists(runCongaOutputDirectory)) {
    dir.create(runCongaOutputDirectory, recursive = T)
  }
  #normalize paths in case they were specified using non-absolute paths.
  runCongaOutputDirectory <- normalizePath(runCongaOutputDirectory)
  tcrFileFromRdiscvr <- normalizePath(tcrFileFromRdiscvr)

  #Run .SeuratToConga() to generate files for the python run_CoNGA() call and normalize paths. 
  .SeuratToCoNGA(seuratObj, tcrFileFromRdiscvr, seuratToCongaDir, assayName = assayName)
  variable_features_file <- normalizePath(paste0(seuratToCongaDir, "/varfeats.csv"))
  tcr_datafile <- normalizePath(paste0(seuratToCongaDir, "/TCRs.csv"))
  gex_datafile <- normalizePath(paste0(seuratToCongaDir, "/GEX.h5"))
  clones_file <- normalizePath(paste0(seuratToCongaDir,"/clones_file.txt"))
  #delete the clones file (overwriting via run_CoNGA.py is kind of a pain) but keep the absolute path definition
  unlink(clones_file)
  
  #copy run_CoNGA.py in inst/scripts and supply custom arguments 
  str <- readr::read_file(system.file("scripts/run_CoNGA.py", package = "CellMembrane"))
  script <- tempfile()
  readr::write_file(str, script)
  newstr <- paste0("run_CoNGA(features_file = '", variable_features_file,
                   "',tcr_datafile = '", tcr_datafile,
                   "', gex_datafile = '", gex_datafile,
                   "', organism = '", organism,
                   "', outfile_prefix = '", runCongaOutputFilePrefix,
                   "', gex_datatype = '", gexDatatype,
                   "', clones_file = '", clones_file,
                   "', outfile_prefix_for_qc_plots = '", runCongaOutfilePrefixForQcPlots,
                   "', working_directory = '", runCongaOutputDirectory,
                   "')")
  #write the new arguments into the script and execute
  readr::write_file(newstr, script, append = TRUE)
  system2(reticulate::py_exe(), script)
  
  #Find the clustering information within the adata2obs.csv (i.e. the  metadata for the representative clones within CoNGA) and append the information to the input Seurat object.
  if (!file.exists(paste0(runCongaOutputDirectory,"/", runCongaOutputFilePrefix,"_adata2obs.csv"))){
    stop(paste0(runCongaOutputFilePrefix,"_adata2obs.csv was not found! Unable to append CoNGA's clustering information to input Seurat object."))
  }

  conga_dataframe <- read.csv(normalizePath(paste0(runCongaOutputDirectory,"/", runCongaOutputFilePrefix,"_adata2obs.csv")))
  #the cell barcodes are stored in "X"
  rownames(conga_dataframe) <- conga_dataframe[,"X"]
  #Append congaMetadataPrefix so we can run Conga iteratively and record the clustering information.
  colnames(conga_dataframe) <- paste0(congaMetadataPrefix, colnames(conga_dataframe))
  seuratObj <- Seurat::AddMetaData(seuratObj, metadata = conga_dataframe[,paste0(congaMetadataPrefix,c("clusters_gex", "clusters_tcr", 'nndists_gex', 'nndists_tcr',
                                                                                                           'is_invariant', 'conga_scores', 'conga_fdr_values'))])
  return(seuratObj)
}

#' @title .SeuratToCoNGA
#' @param seuratObj The Seurat object to be written into a 10x file format
#' @param tcrFileFromRdiscvr The 10x clonotypes file for this run created by Rdiscvr::CreateMergedTcrClonotypeFile().
#' @param seuratToCongaDir The local path to write the output files.
#' @param assayName The name of the gene expression data assay.
#' @description A wrapper function to prepare a Seurat object for Conga.
#' @export
.SeuratToCoNGA <- function(seuratObj, 
                           tcrFileFromRdiscvr, 
                           seuratToCongaDir, 
                           assayName = 'RNA') {
  if (!dir.exists(seuratToCongaDir)) {
    dir.create(seuratToCongaDir, recursive = T)
  }
  #create these files so we can return global paths via normalizePath()
  if (!file.exists(paste0(seuratToCongaDir, "/varfeats.csv"))){
    file.create(paste0(seuratToCongaDir, "/varfeats.csv"))
  }
  if (!file.exists(paste0(seuratToCongaDir, "/TCRs.csv"))){
    file.create(paste0(seuratToCongaDir, "/TCRs.csv"))
  }
  if (!file.exists(paste0(seuratToCongaDir, "/GEX.h5"))){
    file.create(paste0(seuratToCongaDir, "/GEX.h5"))
  }
  #clones_file will be referenced downstream within RunConga()
  if (!file.exists(paste0(seuratToCongaDir, "/clones_file.txt"))){
    file.create(paste0(seuratToCongaDir, "/clones_file.txt"))
  }
  write.table(Seurat::VariableFeatures(seuratObj), normalizePath(paste0(seuratToCongaDir, "/varfeats.csv")), row.names = FALSE, col.names = FALSE)
  file.copy(from = normalizePath(tcrFileFromRdiscvr), 
            to = normalizePath(paste0(seuratToCongaDir, "/TCRs.csv")), 
            overwrite = T)
  
  DropletUtils::write10xCounts(x = seuratObj@assays[[assayName]]@counts, 
                               path = normalizePath(paste0(seuratToCongaDir, "/GEX.h5")), 
                               overwrite = TRUE)
}