
utils::globalVariables(
  names = c('barcode', 'clusters_gex', 'clusters_tcr', 'nndists_gex', 'nndists_tcr', 'is_invariant', 'conga_scores', 'conga_fdr_values'),
  package = 'CellMembrane',
  add = TRUE
)

#' @title SeuratToCoNGA
#' @param seuratObj The seurat object
#' @param tcr_file_from_rdiscvr The 10x clonotypes file for this run created by Rdiscvr::CreateMergedTcrClonotypeFile().
#' @param outputDir The local path to write the output files. The critical files are 
#' @param assayName The name of the gene expression data assay.
#' @param overwrite Boolean describing whether or not to overwrite the GEX info through write10xCounts().
#' @description A wrapper function to prepare a Seurat object for Conga.
#' @export
SeuratToCoNGA <- function(seuratObj, tcr_file_from_rdiscvr, outputDir, assayName = 'RNA', overwrite = TRUE) {
  if (!dir.exists(outputDir)) {
    dir.create(outputDir, recursive = T)
  }
  write.table(Seurat::VariableFeatures(seuratObj), paste0(outputDir, "/varfeats.csv"), row.names = FALSE, col.names = FALSE)
  file.copy(tcr_file_from_rdiscvr, paste0(outputDir, "/TCRs.csv"))
  
  DropletUtils::write10xCounts(x = seuratObj@assays[[assayName]]@counts, 
                               path = paste0(outputDir, "/GEX.h5"), 
                               overwrite = overwrite)
}

#' @title Run CoNGA
#'
#' @description Runs CoNGA on data generated by CellMembrane::SeuratToCoNGA()
#' @param variable_features_file textfile with list of most variable genes. This should be outputDir(from SeuratToConga())/varfeats.csv.
#' @param tcr_datafile Merged TCR clonotype file created by SeuratToConga(). This should be outputDir(from SeuratToConga())/TCRs.csv.
#' @param gex_datafile h5 file created by SeuratToConga(). This should be outputDir(from SeuratToConga())/GEX.h5.
#' @param organism 'human' or 'rhesus'
#' @param outfile_prefix prefix for the output files.
#' @param gex_datatype This should be "10x_h5" since we're using DropletUtils to write the counts, although "h5ad" is supported.
#' @param clones_file Clones file to be generated by RunCoNGA. This should a text file (e.g. "outputDir/clones_file.txt").
#' @param outfile_prefix_for_qc_plots Prefix for the qc output files.
#' @param working_directory The current working directory (to be passed into python to run CoNGA).
#' @param return_seurat Boolean determining if Conga should return a Seurat object or not. If not, the files created during the CoNGA step of RunCoNGA will still be written.
#' @param seuratObj The Seurat object input to SeuratToConga(). This is only necessary if you want a Seurat object with the CoNGA metadata returned.
#' @param conga_metadata_prefix A prefix to be added to the columns of the metadata that will be added from CoNGA within the returned Seurat object.
#' @return A Seurat object with the conga metadata relevant to TCR + gene expression clustering appended. 
#'
#' @export

RunCoNGA <- function(variable_features_file, tcr_datafile, gex_datafile, organism,
                     outfile_prefix, 
                     gex_datatype = "10x_h5", 
                     clones_file, 
                     outfile_prefix_for_qc_plots, 
                     working_directory = getwd(), 
                     return_seurat = T, 
                     seuratObj=NULL,
                     conga_metadata_prefix = "conga_") {
  
  if (!reticulate::py_available(initialize = TRUE)) {
    stop(paste0('Python/reticulate not configured. Run "reticulate::py_config()" to initialize python'))
  }
  
  if (!reticulate::py_module_available('conga')) {
    stop('The conga python package has not been installed! If you believe it has been installed, run reticulate::import("conga") to get more information and debug')
  }
  
  if (return_seurat & is.null(seuratObj)){
    stop("return_seurat is TRUE, but seuratObj is NULL. Please supply the Seurat object used in the SeuratToConga function.")
  }
  
  #strip trailing slashes from working directory if user-supplied
  if (grepl("/$", working_directory)){
    working_directory <- gsub("/$", "", working_directory)
  }
  
  #copy run_CoNGA.py in inst/scripts and supply custom arguments 
  str <- readr::read_file(system.file("scripts/run_CoNGA.py", package = "CellMembrane"))
  script <- tempfile()
  readr::write_file(str, script)
  newstr <- paste0("run_CoNGA(features_file = '", variable_features_file,
                   "',tcr_datafile = '", tcr_datafile,
                   "', gex_datafile = '", gex_datafile,
                   "', organism = '", organism,
                   "', outfile_prefix = '", outfile_prefix,
                   "', gex_datatype = '", gex_datatype,
                   "', clones_file = '", clones_file,
                   "', outfile_prefix_for_qc_plots = '", outfile_prefix_for_qc_plots,
                   "', working_directory = '", working_directory,
                   "')")
  #write the new arguments into the script and execute
  readr::write_file(newstr, script, append = TRUE)
  system2(reticulate::py_exe(), script)
  
  #Find the clustering information within the adata2obs.csv (i.e. the  metadata for the representative clones within CoNGA) and append the information to the input Seurat object.
  if (!file.exists(paste0(working_directory,"/", outfile_prefix,"_adata2obs.csv"))){
    stop(paste0(outfile_prefix,"_adata2obs.csv was not found! Unable to append CoNGA's clustering information to input Seurat object."))
  }
  if (return_seurat){
    conga_dataframe <- read.csv(paste0(working_directory,"/", outfile_prefix,"_adata2obs.csv"))
    #the cell barcodes are stored in "X"
    rownames(conga_dataframe) <- conga_dataframe[,"X"]
    #Append conga_metadata_prefix so we can run Conga iteratively and record the clustering information.
    colnames(conga_dataframe) <- paste0(conga_metadata_prefix, colnames(conga_dataframe))
    seuratObj <- Seurat::AddMetaData(seuratObj, metadata = conga_dataframe[,paste0(conga_metadata_prefix,c("clusters_gex", "clusters_tcr", 'nndists_gex', 'nndists_tcr',
                                                                                                           'is_invariant', 'conga_scores', 'conga_fdr_values'))])
  }
}